@{
    ViewBag.Title = "成果列表";
}
<div class="mini-toolbar" style="padding: 0px; border: 0">
    <table>
        <tr>
            <td style="width: 100%;">
                <a class="mini-button" iconcls="icon-add" onclick="addlist();">批量增加</a> <a class="mini-button"
                    iconcls="icon-add" onclick="beforeAdd()">增加</a> <a class="mini-button" iconcls="icon-edit"
                        onclick="edit({height: 380});">编辑</a> <a class="mini-button" iconcls="icon-remove"
                            onclick="del();">删除</a> <a class="mini-button" iconcls="icon-goto" onclick="startFlow">
                                送校审</a> <a class="mini-button" iconcls="icon-goto" onclick="startCoSignFlow">发起会签</a>
            </td>
            <td style="white-space: nowrap;">
                <input id="key" class="mini-buttonedit gw-searchbox" emptytext="请输入编号或名称" onenter="quickSearch('Code,Name');"
                    onbuttonclick="quickSearch('Code,Name');" />
                <a id="searchBtn" class="mini-button" onclick="showWindow('queryWindow')" iconcls="icon-find"
                    plain="true">详细查询</a>
            </td>
        </tr>
    </table>
</div>
<div class="mini-fit">
    <div id="dataGrid" class="mini-datagrid" style="width: 100%; height: 100%;" url="GetDesignTaskProductsList"
        multiselect="true" borderstyle="border-left:0;border-right:0;">
        <div property="columns">
            <div type="checkcolumn">
            </div>
            <div field="Code" width="80" allowsort="true" align="left">
                编号</div>
            <div field="Name" width="*" allowsort="true" align="left">
                名称</div>
            <div field="FileType" width="60" allowsort="true" align="center">
                类型</div>
            <div field="ToA1" width="60" allowsort="true" align="center">
                折合A1</div>
            <div field="AuditState" width="80" allowsort="true" allowsort="true" align="center">
                校审状态</div>
            <div field="CreateUser" width="80" allowsort="true" align="center">
                提交人</div>
            <div field="SubmitDate" width="100" allowsort="true" align="center" dateformat="yyyy-MM-dd">
                提交日期
            </div>
        </div>
    </div>
</div>
<div id="queryWindow" class="mini-window" title="详细查询" style="width: 690px; height: 185px;">
    <div class="queryDiv">
        <form id="queryForm" method="post">
        <table>
            <tr>
                <td width="15%">
                    编号
                </td>
                <td width="35%">
                    <input name="$LK$Code" class="mini-textbox" style="width: 100%;" />
                </td>
                <td width="10%">
                    名称
                </td>
                <td width="35%">
                    <input name="$LK$Name" class="mini-textbox" style="width: 100%;" />
                </td>
                <td width="5%" />
            </tr>
            <tr>
                <td>
                    提交日期
                </td>
                <td>
                    <input name="$FR$SubmitDate" class="mini-datepicker" style="width: 100%" />
                </td>
                <td>
                    至
                </td>
                <td>
                    <input name="$TO$SubmitDate" class="mini-datepicker" style="width: 100%" />
                </td>
            </tr>
            <tr>
                <td>
                    提交人
                </td>
                <td>
                    <input name="$EQ$CreateUserID" textname="CreateUser" style="width: 100%" class="mini-buttonedit" />
                </td>
            </tr>
        </table>
        </form>
        <div>
            <a class="mini-button" onclick="search()" iconcls="icon-find" style="margin-right: 20px;">
                查询</a> <a class="mini-button" onclick="clearQueryForm()" iconcls="icon-undo">清空</a>
        </div>
    </div>
</div>
<script type="text/javascript">
    var ProductFileType = [{ "value": "说明书", "text": "说明书" }, { "value": "图纸", "text": "图纸" }, { "value": "计算书", "text": "计算书"}]; 
    var AuditState = [{ "text": "未提交", "value": "Create" }, { "text": "设计人提交", "value": "Design" }, { "text": "校核中", "value": "Collact" }, { "text": "审核中", "value": "Audit" }, { "text": "审定中", "value": "Approve" }, { "text": "通过", "value": "Pass"}]; 

</script>
<script type="text/javascript">
    var projectInfoID = getQueryString("ProjectInfoID");
    var wbsID = getQueryString("WBSID");
    var showBtn = getQueryString("IsLeaf");
    addSingleUserSelector("$EQ$CreateUserID");
    addGridEnum("dataGrid", "FileType", "ProductFileType");
    addGridEnum("dataGrid", "AuditState", "AuditState");
    addGridLink('dataGrid', 'Name', 'Edit?ID={ID}', { funcType: 'view', height: 380 });
//    if (showBtn == "true")
//        $(".mini-button").show();
//    else
//        $(".mini-button").hide();

//    $("#searchBtn").show();

    function beforeAdd() {
        add({ height: 400 });
    }

    function startFlow() {
        var dataGrid = mini.get("dataGrid");
        var rows = dataGrid.getSelecteds();
        if (rows.length == 0) { msgUI("请至少选择一个成果"); return; }

        var ProductIDs = "";
        $.each(rows, function (i, e) {
            ProductIDs += e.ID + ",";
        })
        ProductIDs = ProductIDs.substring(0, ProductIDs.length - 1);

        addExecuteParam("ProductIDs", ProductIDs);
        addExecuteParam("WBSID", wbsID);
        addExecuteParam("ProjectInfoID", projectInfoID);
        execute("StartAuditFlow", {
            refresh: false, showLoading: true, validateForm: false,
            onComplete: function (data) {
                dataGrid.reload();
            }
        });
    }

    function addlist() {
        var url = "BatchAdd?ProjectInfoID=" + projectInfoID + "&WBSID=" + wbsID;
        openWindow(url, { refresh: true, title: "批量增加", width: 750, height: 450,
            onDestroy: function (data) {
                if (data != "close")
                    mini.get("dataGrid").reload();
            }
        });
    }

    function HasSubChanged() {
        var hasSub = mini.getbyName("HasSub").getValue();
        var grid = mini.get("dataGrid");
        var url = addSearch(addUrlSearch(grid.getUrl().split('?')[0]), "HasSub", hasSub);
        grid.setUrl(url);
        grid.load();
    }

    function startCoSignFlow() {
        var dataGrid = mini.get("dataGrid");
        var rows = dataGrid.getSelecteds();
        if (rows.length == 0) {
            msgUI("请至少选择一个成果");
            return;
        }
        var ProductIDs = "";
        $.each(rows, function (i, e) {
            ProductIDs += e.ID + ",";
        })
        ProductIDs = ProductIDs.substring(0, ProductIDs.length - 1);
        var url = "/Project/Extend/CoSign/Edit?ProductIDs=" + ProductIDs;
        flowAdd("CoSign", { url: url });

    }
</script>
